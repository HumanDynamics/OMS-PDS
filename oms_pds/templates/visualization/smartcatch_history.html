{% extends "base.html" %}

{% block title %}
smartCATCH
{% endblock %}

{% block scripts %}
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <link rel="import" href="/static/mgh/contents/graph.html">
  <link rel="import" href="/static/mgh/contents/line_graph.html">
  <link type="text/css" rel="stylesheet" href="/static/mgh/contents/stylesheet.css">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <link rel="import" href="/static/mgh/components/font-roboto/roboto.html">
  <link rel='import' href="/static/mgh/components/core-icon-button/core-icon-button.html">
  <link rel="import" href="/static/mgh/components/core-header-panel/core-header-panel.html">
  <link rel="import" href="/static/mgh/components/core-toolbar/core-toolbar.html">
  <link rel="import" href="/static/mgh/components/paper-tabs/paper-tabs.html">
  
  <style>
	html{
		width:350px;
		overflow-x: hidden;
	}
	html,body {
		background-color:#f6f6f6
		font-family: 'RobotoDraft', sans-serif;
	  }
	  core-header-panel {
		height: 100%;
	  }
	  core-toolbar {
		background: #03a9f4;
		color: white;
	  }
	  paper-tabs {
		width: 100%;
		-webkit-user-select: none;
		-moz-user-select: none;
		-ms-user-select: none;
		user-select: none;
	  }
	  .scontainer {
		width: 80%;
		margin: 50px auto;
	  }
	  @media (min-width: 481px) {
		paper-tabs {
		  width: 45em;
		}
		.scontainer {
		  width: 350px;
		}
	  }
	</style>
{% endblock %}

{% block content %}
<div id="mainPage">
	<!--<div id="logo-border-blue">
		<img id="Logo" src="/static/mgh/SmartCatch_design_app/Img/general/Logo_blue.png"/>
	</div>-->
	
  <div id="subheader1">
      
      <div id="time-filter-buttons">
	    <div id="day-line" class="filter-button">Today</div>
	    <div id="week-line" class="filter-button">This Week</div>
	    <div id="month-line" class="filter-button">This Month</div>
	    <div id="full-line" class="filter-button">Complete</div>
      </div>
  </div>
      
	<div id="sorted-lines">
	    <div class="group-results-history">Group results <div class="group-results-button">Off</div></div>
	    
	       {% if goaltype != 'n' %}
		<div id="goalCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/interactions_01.png" /></div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="goalSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="goalSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="goalSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="goalSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>
		{% endif %}
	
		<div id="gluCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/blood_01.png" />Glucose</div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="glucSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="glucSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="glucSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="glucSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>
	
		<div id="medCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/drugs_01.png" />Medication Adherence</div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="medsSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="medsSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="medsSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="medsSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>

		<div id="slpCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/sleep_01.png" />Sleep</div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="sleepSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="sleepSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="sleepSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="sleepSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>

		<div id="socCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/interactions_01.png" />Social</div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="socSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="socSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="socSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="socSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>
		
		<div id="actCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/activity_01.png" />Activity</div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="actSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="actSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="actSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="actSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>
		
		<div id="regCardLine" class="lineGraph">
			<div class="lineLabel"><img class="graphPic" src="/static/mgh/SmartCatch_design_app/Img/category_icons/regularity_01.png" />Routine</div>
			{% if not control %}
			<div class="yaxis"><div>100</div><div>0</div></div>
			<div class="lineBack"></div>
			<div class="lineBorder"></div>
			<svg id="regSVG-full" class="full-line" width="622" height="320"></svg>
			<svg id="regSVG-month" class="month-line" width="622" height="320"></svg>
			<svg id="regSVG-week" class="week-line" width="622" height="320"></svg>
			<svg id="regSVG-day" class="day-line" width="622" height="320"></svg>
			{% endif %}
		</div>
		
	
	</div>
		
	<div id="footer"></div>
</div>

<script>
var goalD=[{{ surveyscores.goal }}];//data for goal //data inputs here
var goalAvgD=[ {{ avgGoal }}];//goal average
var socD=[{{ socialhealth.user.social }}];//data for social
var socAvgD=[ {{ avgSocial }} ];//for social average
var actD=[{{ socialhealth.user.activity }}];//for activity
var actAvgD=[ {{ avgActivity }} ];//for activity average
var slpD=[{{ surveyscores.sleep }}];//for sleep
var slpAvgD=[{{ avgSleep }}];//for sleep average
var regD=[{{ socialhealth.user.focus }}];//for regularity
var regAvgD=[{{ avgFocus }}];//for regularity average
var gluD=[{{ surveyscores.glucose }}];// glucose
var gluAvgD=[{{ avgGlucose }}];//glucose average
var medD=[{{ surveyscores.meds }}];// medication
var medAvgD=[{{ avgMeds }}];//medication average
var gluGAvgD=[98,90,29,87,54]
var medGAvgD= [76,89,95,86,45]
var socGAvgD=[{{socialhealth.user_group.social}}];//for social average
var actGAvgD=[{{socialhealth.user_group.activity}}];//for activity group average
var regGAvgD=[{{socialhealth.user_group.focus}}];//for regularity average
var slpGAvgD=[12,96,24,91];

// date
var d = new Date();
var day = d.getDate();
var month = d.getMonth();
var dayOfWeek= d.getDay();
var weeks=1;
var months=["Jan","Feb","Mar","Apr","May","June","July","Aug","Sep","Oct"," Nov","Dec"];
if(dayOfWeek==0){
	weeks++};
	
$(".date").text(months[month]+" "+day + " / week " + weeks);
//averages data
var Avg=function(data){
	var sum=0;
	for(var x = 0; x<data.length;x++)
		{sum+=data[x]};
	var avg=sum/data.length;
	return Math.round(avg);
	};

var numCompare= function(present, average){
	var diff= Avg(present)-Avg(average);
	var percentChange=((diff/Avg(average))*100);
	return percentChange
};

//person goal stuff
var goalType = "{{ goaltype }}";
var goal="none selected";
var goalImage="";
var goalQuestion="";
var goalOptions="";
switch(goalType){
	case "f":
	        goal = 'feet care';
		goalImage="/static/mgh/SmartCatch_design_app/Img/category_icons/feet_01.png";
		console.log(goal+ "1");
		goalQuestion="Have you checked your feet today?";
		goalOptions='<div class="qNum feetQNum" ></div><div class="questionText feetQ"></div><br><input class="feetQ" type="radio" name="feetQ" value="yes" id="feetY"><label for="feetY" class="feetQ"><div class="qButton feetButton">Yes</div></label><input class="feetQ" type="radio" name="feetQ" value="no" id="feetN"><label for="feetN" class="feetQ"><div class="qButton feetButton">No</div><br>'
		break;
	case "s":
	        goal = 'smoking';
		goalImage="/static/mgh/SmartCatch_design_app/Img/category_icons/smoking_01.png";
		console.log(goal+ "2");
		goalQuestion="Rate how many less cigarettes you smoked today compared to yesterday on a scale of 0 ( I smoked the same or more today) to 40 less than yesterday. "
		goalOption='<input class="smokingQ" type="range" data-show-value="true" min="0" max="40"></br>'
		break;
	case "e":
	        goal = 'eating healthy';
		goalImage="/static/mgh/SmartCatch_design_app/Img/category_icons/eathealthy_01.png";
		console.log(goal+ "3");
		goalQuestion="Rate your eating today on a scale of 1  (I really made bad food choices today)  to 10 (I ate really healthy-today)"
		goalOption='<input class="eatingQ" type="range" data-show-value="true" min="0" max="10"></br>'
		break;
	case "t":
	        goal = 'stress level';
		goalImage="/static/mgh/SmartCatch_design_app/Img/category_icons/stress_01.png";
		console.log(goal+ "4");
		goalQuestion="Rate your stress reduction techniques today on a scale of 1 (I practiced very good techniques to reduce my feelings of stress today) to 10 ( I was very stressed out and I did nothing to help myself calm down). "
		goalOption='<input class="stressQ" type="range" data-show-value="true" min="0" max="10"></br>'
		break;
	}
$('#goalCardLine .graphPic').attr('src',goalImage);
$('#goalCardLine .lineLabel').append(goal);

//how well text
var doingWell="You are doing well / ";
var doingokay="You can do better / ";
var doingPoor="Not that great / ";
//color change for bars
var socialColor= 'white';
var activityColor='white';
var regularityColor='white';
var goalColor='white';
var sleepColor="white";
var glucoseColor='white';
var medicationColor="white";

if(Avg(socD)<=50){
	socialColor='#Fc4c4c';
	$('#socAvg').addClass('stripe-r');
	}
else if(Avg(socD)>=70){
	socialColor='#27dc84';
	$('#socAvg').addClass('stripe-g');}
else{
	socialColor='#f9ce20';
	$('#socAvg').addClass('stripe-y');};
	
if(Avg(actD)<=50){
	activityColor='#Fc4c4c';
	$('#actAvg').addClass('stripe-r');}
else if(Avg(actD)>=70){
	activityColor='#27dc84';
	$('#actAvg').addClass('stripe-g');}
else{
	activityColor='#f9ce20';
	$('#actAvg').addClass('stripe-y');};
	
if(Avg(regD)<=50){
	regularityColor='#Fc4c4c';
	$('#regAvg').addClass('stripe-r');}
else if(Avg(regD)>=70){
	regularityColor='#27dc84';
	$('#regAvg').addClass('stripe-g');}
else{
	regularityColor='#f9ce20';
	$('#regAvg').addClass('stripe-y');};
	
if(Avg(slpD)<=50){
	sleepColor='#fc4c4c';
	$('#slpAvg').addClass('stripe-r');}
else if(Avg(slpD)>=70){
	sleepColor='#27dc84';
	$('#slpAvg').addClass('stripe-g');}
else{
	sleepColor='#f9ce20';
	$('#slpAvg').addClass('stripe-y');};

if(Avg(gluD)<=50){
	glucoseColor='#Fc4c4c';
	$('#gluAvg').addClass('stripe-r');}
else if(Avg(gluD)>=70){
	glucoseColor='#27dc84';
	$('#gluAvg').addClass('stripe-g');}
else{
	glucoseColor='#f9ce20';
	$('#gluAvg').addClass('stripe-y');};
	
if(Avg(medD)<=50){
	medicationColor='#Fc4c4c';
	$('#medAvg').addClass('stripe-r');}
else if(Avg(medD)>=70){
	medicationColor='#27dc84';
	$('#medAvg').addClass('stripe-g');}
else{
	medicationColor='#f9ce20';
	$('#medAvg').addClass('stripe-y');};
	
if(Avg(goalD)<=50){
	goalColor='#Fc4c4c';
	$('#goalAvg').addClass('stripe-r');}
else if(Avg(slpD)>=70){
	goalColor='#27dc84';
	$('#goalAvg').addClass('stripe-g');}
else{
	goalColor='#f9ce20';
	$('#goalAvg').addClass('stripe-y');};
	
$('#socWeekScore').text(Avg(socD)).css('color',socialColor);
$('#actWeekScore').text(Avg(actD)).css('color',activityColor);
$('#regWeekScore').text(Avg(regD)).css('color',regularityColor);
$('#slpWeekScore').text(Avg(slpD)).css('color',sleepColor);
$('#goalWeekScore').text(Avg(goalD)).css('color',goalColor);
$('#medWeekScore').text(Avg(medD)).css('color',medicationColor);
$('#gluWeekScore').text(Avg(gluD)).css('color',glucoseColor);
$('#regAvgScore').text(Avg(regAvgD)).css('color',regularityColor);
$('#goalAvgScore').text(Avg(goalAvgD)).css('color',goalColor);
$('#socAvgScore').text(Avg(socAvgD)).css('color',socialColor);
$('#actAvgScore').text(Avg(actAvgD)).css('color',activityColor);
$('#slpAvgScore').text(Avg(slpAvgD)).css('color',sleepColor);
$('#medAvgScore').text(Avg(medAvgD)).css('color',medicationColor);
$('#gluAvgScore').text(Avg(gluAvgD)).css('color', glucoseColor);
$('#actGroupScore').text(Avg(actGAvgD));
$('#regGroupScore').text(Avg(regGAvgD));
$('#socGroupScore').text(Avg(socGAvgD));
$('#slpGroupScore').text(Avg(slpGAvgD));
$('#medGroupScore').text(Avg(medGAvgD));
$('#gluGroupScore').text(Avg(gluGAvgD));

$('.socialBars').css('background-color',socialColor);
$('.activityBars').css('background-color',activityColor);
$('.regularityBars').css('background-color',regularityColor);
$('.sleepBars').css('background-color',sleepColor)
$('.medicationBars').css('background-color',medicationColor)
$('.glucoseBars').css('background-color',glucoseColor)
$('.goalBars').css('background-color',goalColor)
		
// line graphs
var margin=[50,20,50,20];
var wid=620;
var height=266;
var socData = [{% for s in socialScoreHistory %}{x:{{s.time}},y:{{ s.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];//data entered here, must have at least 7 in one of them
var actData = [{% for a in activityScoreHistory %}{x:{{a.time}},y:{{ a.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];//or it will show decimals
var regData = [{% for f in focusScoreHistory %}{x:{{f.time}},y:{{ f.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var slpData = [{% for s in sleepScoreHistory %}{x:{{s.time}},y:{{ s.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var gluData = [{% for g in glucoseScoreHistory %}{x:{{g.time}},y:{{ g.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var medData = [{% for m in medsScoreHistory %}{x:{{m.time}},y:{{ m.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var goalData = [{% for m in goalScoreHistory %}{x:{{m.time}},y:{{ m.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var socGData = [{% for s in socialScoreGroupHistory %}{x:{{s.time}},y:{{ s.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];//data entered here, must have at least 7 in one of them
var actGData = [{% for a in activityScoreGroupHistory %}{x:{{a.time}},y:{{ a.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];//or it will show decimals
var regGData = [{% for f in focusScoreGroupHistory %}{x:{{f.time}},y:{{ f.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];

var sleepGData = [{% for f in sleepScoreGroupHistory %}{x:{{f.time}},y:{{ f.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var glucGData = [{% for f in glucoseScoreGroupHistory %}{x:{{f.time}},y:{{ f.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var medsGData = [{% for f in medsScoreGroupHistory %}{x:{{f.time}},y:{{ f.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];
var goalGData = [{% for f in goalScoreGroupHistory %}{x:{{f.time}},y:{{ f.score }}}{% if not forloop.last %},{% endif %}{% endfor %}];

var dayCutoff = {{ dayCutoff }} * 1000;
var weekCutoff = {{ weekCutoff }} * 1000;
var monthCutoff = {{ monthCutoff }} * 1000;

function cleanData(data) {
      var newlist = []
      for (d in data) {
	    data[d]["x"] *= 1000; //convert from s to ms
	    newlist.push(data[d]);
      }
      return newlist;
}

function filterPoints(data, cutoff) {
      var newlist = []
      for (d in data) {
	    if (data[d]["x"] >= cutoff) {
		  newlist.push(data[d]);
	    }
      }
      return newlist;
}
var CHART_WIDTH = 622;
var CHART_HEIGHT = 267;
var CHART_MARGINS = {
  top: 0,
  right: 35,
  bottom: 0,
  left: 40
};
var CHART_Y_RANGE = d3.scale.linear().range([CHART_HEIGHT - CHART_MARGINS.top, CHART_MARGINS.bottom]).domain([0,100]);

function generateAxes(svg, xRange) {
      xAxis = d3.svg.axis()
	    .scale(xRange)
	    .tickSize(0)
	    .ticks(5)
	    .tickSubdivide(true);
 
      svg.append('svg:g')
	.attr('class', 'x axis')
	.attr('transform', 'translate(0,300)')
	.attr("font-size", "13pt")
	.attr("font-family", "Roboto Light")
	.call(xAxis);
	
      var ygrid =
      d3.svg.axis()
	    .scale(xRange)
	    .ticks(5)
	    .tickFormat("")
	    .tickSize(266);
      svg.append("g")
	.attr("transform", "translate(0, 0)")
        .call(ygrid)
	
}

function setupLine(id, data, color, cutoff, label) {
      var svg = d3.select(id);
      
      if (cutoff == null) {
	    xRange = d3.time.scale().range([CHART_MARGINS.left, CHART_WIDTH - CHART_MARGINS.right]).domain([CHART_MARGINS.left, CHART_WIDTH - CHART_MARGINS.right])
	    .domain([d3.min(data, function(d) {
	      return d.x;
	    }), d3.max(data, function(d) {
	      return d.x;
	    })]);
      } else {
	    xRange = d3.time.scale().range([CHART_MARGINS.left, CHART_WIDTH - CHART_MARGINS.right]).domain([CHART_MARGINS.left, CHART_WIDTH - CHART_MARGINS.right])
	    .domain([new Date(cutoff), new Date()]);//[cutoff, d3.max(data, function(d) { return d.x; })]);
      }
      
      generateAxes(svg, xRange);
      
      // assembling line
      var lineFunc = d3.svg.line()
	.x(function(d) {
	  return xRange(d.x);
	})
	.y(function(d) {
	  return CHART_Y_RANGE(d.y);
	})
	.interpolate('linear');
      svg.append('svg:path')
	.attr('d', lineFunc(data))
	.attr('stroke', color)
	.attr('stroke-width', 5)
	.attr('fill', 'none')
	.attr('class', label);
}

function setupFilteredDataLines(id, data, color, label) {
      var cleanedData = cleanData(data);
      setupLine(id+"-full", cleanedData, color, null, label);
      var dataMonth = filterPoints(cleanedData, monthCutoff);
      setupLine(id+"-month", dataMonth, color, monthCutoff, label);
      var dataWeek = filterPoints(dataMonth, weekCutoff);
      setupLine(id+"-week", dataWeek, color, weekCutoff, label);
      var dataDay = filterPoints(dataWeek, dayCutoff);
      setupLine(id+"-day", dataDay, color, dayCutoff, label);
}

var groupColor = "#7092a2";
setupFilteredDataLines("#actSVG", actData, activityColor, "");
setupFilteredDataLines("#socSVG", socData, socialColor, "");
setupFilteredDataLines("#regSVG", regData, regularityColor, "");
setupFilteredDataLines("#sleepSVG", slpData, sleepColor, "");
setupFilteredDataLines("#medsSVG", medData, medicationColor, "");
setupFilteredDataLines("#glucSVG", gluData, glucoseColor, "");
setupFilteredDataLines("#goalSVG", goalData, goalColor, "");

setupFilteredDataLines("#actSVG", actGData, groupColor, "group-line");
setupFilteredDataLines("#socSVG", socGData, groupColor, "group-line");
setupFilteredDataLines("#regSVG", regGData, groupColor, "group-line");

/* TODO !!! These need to be done*/
setupFilteredDataLines("#sleepSVG", sleepGData, groupColor, "group-line");
setupFilteredDataLines("#medsSVG", medsGData, groupColor, "group-line");
setupFilteredDataLines("#glucSVG", glucGData, groupColor, "group-line");
setupFilteredDataLines("#goalSVG", goalGData, groupColor, "group-line");

$(".filter-button").click(function() {
   $("svg").hide();
   $("." + $(this).attr("id")).show();
   $(".button-selected").removeClass("button-selected");
   $(this).addClass("button-selected");
}).eq(0).click();

$(".group-results-button").click(function() {
      if ($(this).hasClass('g-on')) {
	    $(this).removeClass('g-on').text("Off");
	    $(".group-line").hide();
      } else {
	    $(this).addClass('g-on').text("On");
	    $(".group-line").show();
      }
});

</script>
{% endblock %}
